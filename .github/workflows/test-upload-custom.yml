name: 测试自定义服务器上传

on:
  workflow_dispatch:
    inputs:
      version:
        description: '测试版本号，将写入 .version 并作为目录名'
        required: false
        default: '0.0.0-test'
        type: string

jobs:
  upload-test:
    name: 自定义上传测试
    runs-on: ubuntu-24.04
    steps:
      - name: 准备测试文件
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version || '0.0.0-test' }}"
          mkdir -p upload/"${VERSION}"
          printf "%s\n" "${VERSION}" > upload/.version
          # 生成一个小型占位包，验证传输逻辑
          echo "hello ${VERSION}" > upload/${VERSION}/msm-${VERSION}-test.txt
          tar -czf upload/${VERSION}/msm-${VERSION}-test.tar.gz -C upload/${VERSION} msm-${VERSION}-test.txt
          rm upload/${VERSION}/msm-${VERSION}-test.txt
          ls -lh upload upload/"${VERSION}"

      - name: 安装 sshpass 与 rsync
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass rsync

      - name: 上传到自定义服务器
        shell: bash
        env:
          EXTRA_SERVERS: ${{ secrets.DEPLOY_SERVERS }}
        run: |
          set -euo pipefail

          VERSION="${{ inputs.version || '0.0.0-test' }}"
          RSYNC_SSH="ssh -o StrictHostKeyChecking=no"

          # 仅使用 DEPLOY_SERVERS，多行 host,user,password,target_path[,port]
          servers=()
          if [ -n "${EXTRA_SERVERS}" ]; then
            while IFS= read -r line; do
              line_trimmed="$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
              [ -z "$line_trimmed" ] && continue
              servers+=("$line_trimmed")
            done <<< "${EXTRA_SERVERS}"
          fi

          if [ ${#servers[@]} -eq 0 ]; then
            echo "未提供服务器信息（请在 secrets 中设置 DEPLOY_SERVERS，多行 host,user,password,target_path[,port]）"
            exit 0
          fi

          echo "即将上传到 ${#servers[@]} 个服务器:"
          for entry in "${servers[@]}"; do
            # 避免完整泄露，host 中间三位替换为 ***
            IFS=',' read -r host user pass target port <<< "$entry"
            safe_host="$(echo "$host" | sed 's/\\([0-9A-Za-z]\\{1,3\\}\\)[0-9A-Za-z]\\{3\\}/\\1***/')"
            echo " - ${safe_host}"
          done

          for entry in "${servers[@]}"; do
            IFS=',' read -r host user pass target port <<< "$entry"
            if [ -z "${host}" ] || [ -z "${user}" ] || [ -z "${pass}" ] || [ -z "${target}" ]; then
              echo "跳过无效配置"
              continue
            fi

            TARGET="${target%/}"
            PORT_OPT=""
            if [ -n "${port}" ]; then
              PORT_OPT="-p ${port}"
            fi

            sshpass -p "${pass}" ssh -o StrictHostKeyChecking=no ${PORT_OPT} "${user}@${host}" "mkdir -p \"${TARGET}\" \"${TARGET}/${VERSION}\""

            sshpass -p "${pass}" rsync -avz --no-perms --no-owner --no-group -e "${RSYNC_SSH} ${PORT_OPT}" --rsync-path="mkdir -p \"${TARGET}\" && rsync" upload/.version "${user}@${host}:${TARGET}/"
            sshpass -p "${pass}" rsync -avz --no-perms --no-owner --no-group -e "${RSYNC_SSH} ${PORT_OPT}" --rsync-path="mkdir -p \"${TARGET}/${VERSION}\" && rsync" upload/${VERSION}/ "${user}@${host}:${TARGET}/${VERSION}/"
          done

          echo "✅ 测试上传完成到全部服务器"
