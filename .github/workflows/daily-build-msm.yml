name: æ¯æ—¥æ„å»º MSM

on:
  schedule:
    # stableï¼šæ¯å¤©å‡Œæ™¨ 4 ç‚¹ï¼ˆUTC æ—¶é—´ 20:00ï¼‰
    - cron: '0 20 * * *'
    # betaï¼ˆdev åˆ†æ”¯ï¼‰ï¼šæ¯å¤©å‡Œæ™¨ 4:30ï¼ˆUTC æ—¶é—´ 20:30ï¼‰
    - cron: '30 20 * * *'
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯ï¼ˆmain=ç¨³å®šç‰ˆï¼Œdev=Beta ç‰ˆï¼‰'
        required: false
        default: 'main'
        type: string
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: daily-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.meta.outputs.version }}
      base_version: ${{ steps.meta.outputs.base_version }}
      channel: ${{ steps.meta.outputs.channel }}
      channel_name: ${{ steps.meta.outputs.channel_name }}
      is_stable: ${{ steps.meta.outputs.is_stable }}
      is_beta: ${{ steps.meta.outputs.is_beta }}
      release_notes_path: ${{ steps.meta.outputs.release_notes_path }}
      latest_marker: ${{ steps.meta.outputs.latest_marker }}
      history_marker: ${{ steps.meta.outputs.history_marker }}
      docker_channel_tag: ${{ steps.meta.outputs.docker_channel_tag }}
      release_docs_url: ${{ steps.meta.outputs.release_docs_url }}
      install_script_name: ${{ steps.meta.outputs.install_script_name }}
      install_script_url: ${{ steps.meta.outputs.install_script_url }}
      commit_sha: ${{ steps.meta.outputs.commit_sha }}
      commit_sha_short: ${{ steps.meta.outputs.commit_sha_short }}
      branch: ${{ steps.meta.outputs.branch }}
      changelog: ${{ steps.meta.outputs.changelog }}
      commit_message: ${{ steps.meta.outputs.commit_message }}
      commit_author: ${{ steps.meta.outputs.commit_author }}
      commit_date: ${{ steps.meta.outputs.commit_date }}
      previous_version: ${{ steps.meta.outputs.previous_version }}
      previous_version_commit: ${{ steps.meta.outputs.previous_version_commit }}
      commit_count: ${{ steps.meta.outputs.commit_count }}
      ai_summary: ${{ steps.ai_summary.outputs.summary }}
      force_update: ${{ steps.meta.outputs.force_update }}
      skip: ${{ steps.meta.outputs.skip }}
    steps:
      - name: Checkout MSM ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: msm9527/msm
          ref: ${{ github.event_name == 'workflow_dispatch' && (inputs.branch || 'main') || (github.event.schedule == '30 20 * * *' && 'dev' || 'main') }}
          token: ${{ secrets.MSM_REPO_TOKEN }}
          fetch-depth: 0

      - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          # ä¼˜å…ˆä»ä»“åº“æ ¹ç›®å½•çš„ .version æ–‡ä»¶è¯»å–ç‰ˆæœ¬å·ï¼ˆmsm ä¸»ä»“åº“çš„å•ä¸€çœŸå®ç‰ˆæœ¬æºï¼‰
          if [ -f ".version" ]; then
            VERSION="$(tr -d '[:space:]' < .version)"
          else
            VERSION=""
          fi

          # å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå¦‚æœ .version ç¼ºå¤±ï¼Œåˆ™å›é€€åˆ°ä»æºç ä¸­è§£æï¼ˆé¿å…æ—§åˆ†æ”¯ç›´æ¥æŠ¥é”™ï¼‰
          if [ -z "${VERSION}" ]; then
            VERSION="$(sed -nE 's/^[[:space:]]*version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' backend/cmd/msm/commands/root.go | head -n 1 || true)"
          fi

          if [ -z "${VERSION}" ]; then
            echo "error: æ— æ³•ä» .version æˆ– backend/cmd/msm/commands/root.go è·å–ç‰ˆæœ¬å·" >&2
            exit 1
          fi

          EVENT_NAME="${{ github.event_name }}"
          EVENT_SCHEDULE="${{ github.event.schedule || '' }}"
          INPUT_BRANCH="${{ inputs.branch || '' }}"

          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            BRANCH="${INPUT_BRANCH:-main}"
          elif [ "${EVENT_NAME}" = "schedule" ] && [ "${EVENT_SCHEDULE}" = "30 20 * * *" ]; then
            BRANCH="dev"
          else
            BRANCH="main"
          fi

          CHANNEL="stable"
          CHANNEL_NAME="ç¨³å®šç‰ˆ"
          IS_STABLE="true"
          IS_BETA="false"
          DOCKER_CHANNEL_TAG="latest"
          RELEASE_NOTES_PATH="docs/zh/guide/releases.md"
          LATEST_MARKER="## ğŸš€ æœ€æ–°ç¨³å®šç‰ˆæœ¬"
          HISTORY_MARKER="## ğŸ“š å†å²ç‰ˆæœ¬"
          RELEASE_DOCS_URL="https://msm9527.github.io/msm-wiki/zh/guide/releases.html"
          INSTALL_SCRIPT_NAME="install.sh"
          INSTALL_SCRIPT_URL="https://raw.githubusercontent.com/msm9527/msm-wiki/main/install.sh"

          if [ "${BRANCH}" = "dev" ]; then
            CHANNEL="beta"
            CHANNEL_NAME="Beta ç‰ˆ"
            IS_STABLE="false"
            IS_BETA="true"
            DOCKER_CHANNEL_TAG="beta-latest"
            RELEASE_NOTES_PATH="docs/zh/guide/releases-beta.md"
            LATEST_MARKER="## ğŸ§ª æœ€æ–° Beta ç‰ˆæœ¬"
            HISTORY_MARKER="## ğŸ“š å†å² Beta ç‰ˆæœ¬"
            RELEASE_DOCS_URL="https://msm9527.github.io/msm-wiki/zh/guide/releases-beta.html"
            INSTALL_SCRIPT_NAME="install_beta.sh"
            INSTALL_SCRIPT_URL="https://raw.githubusercontent.com/msm9527/msm-wiki/main/install_beta.sh"
          fi

          BASE_VERSION="${VERSION}"
          RELEASE_VERSION="${VERSION}"
          if [ "${CHANNEL}" = "beta" ]; then
            RELEASE_VERSION="beta-${VERSION}"
          fi

          FORCE_UPDATE="${{ inputs.force_update || 'false' }}"
          COMMIT_SHA="$(git rev-parse HEAD)"
          COMMIT_SHA_SHORT="$(git rev-parse --short=7 HEAD)"

          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          COMMIT_MESSAGE="$(git log -1 --pretty=format:'%s')"
          COMMIT_AUTHOR="$(git log -1 --pretty=format:'%an')"
          COMMIT_DATE="$(git log -1 --pretty=format:'%ci')"

          # é€šè¿‡ .version å†å²è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬åŠå…¶æäº¤ï¼ˆç”¨äºç¡®å®šæäº¤èŒƒå›´ï¼‰
          PREVIOUS_VERSION=""
          PREVIOUS_VERSION_COMMIT=""
          if [ -f ".version" ]; then
            while read -r VERSION_COMMIT; do
              VERSION_AT_COMMIT="$(git show "${VERSION_COMMIT}:.version" 2>/dev/null | tr -d '[:space:]' || true)"
              if [ -z "${VERSION_AT_COMMIT}" ]; then
                continue
              fi
              if [ "${VERSION_AT_COMMIT}" != "${VERSION}" ]; then
                PREVIOUS_VERSION="${VERSION_AT_COMMIT}"
                PREVIOUS_VERSION_COMMIT="${VERSION_COMMIT}"
                break
              fi
            done < <(git log --follow --format=%H -- .version)
          fi

          # å¦‚æœæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æäº¤ï¼Œè·å–ä»è¯¥æäº¤åˆ°å½“å‰çš„æ‰€æœ‰æäº¤
          # å¦åˆ™è·å–æœ€è¿‘ 20 æ¡æäº¤
          if [ -n "${PREVIOUS_VERSION_COMMIT}" ]; then
            echo "æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬: ${PREVIOUS_VERSION} (${PREVIOUS_VERSION_COMMIT})"
            CHANGELOG="$(git log ${PREVIOUS_VERSION_COMMIT}..HEAD --pretty=format:'- [%h](https://github.com/msm9527/msm/commit/%H) %s _%an, %ar_' | sed 's/$/\\n/' | tr -d '\n')"
            COMMIT_COUNT="$(git rev-list --count ${PREVIOUS_VERSION_COMMIT}..HEAD)"
          else
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æäº¤ï¼Œä½¿ç”¨æœ€è¿‘ 20 æ¡æäº¤"
            CHANGELOG="$(git log -20 --pretty=format:'- [%h](https://github.com/msm9527/msm/commit/%H) %s _%an, %ar_' | sed 's/$/\\n/' | tr -d '\n')"
            COMMIT_COUNT="20"
          fi

          echo "version=${RELEASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "base_version=${BASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "channel=${CHANNEL}" >> "$GITHUB_OUTPUT"
          echo "channel_name=${CHANNEL_NAME}" >> "$GITHUB_OUTPUT"
          echo "is_stable=${IS_STABLE}" >> "$GITHUB_OUTPUT"
          echo "is_beta=${IS_BETA}" >> "$GITHUB_OUTPUT"
          echo "release_notes_path=${RELEASE_NOTES_PATH}" >> "$GITHUB_OUTPUT"
          echo "latest_marker=${LATEST_MARKER}" >> "$GITHUB_OUTPUT"
          echo "history_marker=${HISTORY_MARKER}" >> "$GITHUB_OUTPUT"
          echo "docker_channel_tag=${DOCKER_CHANNEL_TAG}" >> "$GITHUB_OUTPUT"
          echo "release_docs_url=${RELEASE_DOCS_URL}" >> "$GITHUB_OUTPUT"
          echo "install_script_name=${INSTALL_SCRIPT_NAME}" >> "$GITHUB_OUTPUT"
          echo "install_script_url=${INSTALL_SCRIPT_URL}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "commit_sha_short=${COMMIT_SHA_SHORT}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "commit_message=${COMMIT_MESSAGE}" >> "$GITHUB_OUTPUT"
          echo "commit_author=${COMMIT_AUTHOR}" >> "$GITHUB_OUTPUT"
          echo "commit_date=${COMMIT_DATE}" >> "$GITHUB_OUTPUT"
          echo "previous_version=${PREVIOUS_VERSION}" >> "$GITHUB_OUTPUT"
          echo "previous_version_commit=${PREVIOUS_VERSION_COMMIT}" >> "$GITHUB_OUTPUT"
          echo "commit_count=${COMMIT_COUNT}" >> "$GITHUB_OUTPUT"
          echo "force_update=${FORCE_UPDATE}" >> "$GITHUB_OUTPUT"

          {
            echo "changelog<<EOF"
            echo "${CHANGELOG}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          RELEASE_URL="https://github.com/msm9527/msm-wiki/releases/tag/${RELEASE_VERSION}"
          if [ "${FORCE_UPDATE}" != "true" ] && [ "${CHANNEL}" = "stable" ]; then
            STATUS="$(curl -I -s -o /dev/null -w '%{http_code}' "${RELEASE_URL}")"
            if [ "${STATUS}" -ge 200 ] && [ "${STATUS}" -lt 400 ]; then
              echo "æ£€æµ‹åˆ°ç‰ˆæœ¬ ${RELEASE_VERSION} å·²å­˜åœ¨äº Release é¡µé¢ (${RELEASE_URL})ï¼Œè·³è¿‡åç»­ä»»åŠ¡"
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

          echo "æ„å»ºé€šé“: ${CHANNEL} (${CHANNEL_NAME})"
          echo "æ„å»ºç‰ˆæœ¬: ${RELEASE_VERSION} (æºç‰ˆæœ¬: ${BASE_VERSION})"
          echo "æ„å»ºåˆ†æ”¯: ${BRANCH}"
          echo "æäº¤ SHA: ${COMMIT_SHA}"
          echo "æœ€æ–°æäº¤: ${COMMIT_MESSAGE}"
          echo "æäº¤æ•°é‡: ${COMMIT_COUNT}"

      - name: ä½¿ç”¨ AI ç”Ÿæˆç‰ˆæœ¬æ€»ç»“
        if: steps.meta.outputs.skip != 'true'
        id: ai_summary
        uses: actions/github-script@v7
        env:
          MODELSCOPE_API_KEY: ${{ secrets.MODELSCOPE_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');

            // è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬ tag
            const previousVersion = '${{ steps.meta.outputs.previous_version }}';
            const previousVersionCommit = '${{ steps.meta.outputs.previous_version_commit }}';
            const commitCount = parseInt('${{ steps.meta.outputs.commit_count }}');

            // æ ¹æ®æ˜¯å¦æœ‰ä¸Šä¸€ä¸ªç‰ˆæœ¬æäº¤ï¼Œè·å–ç›¸åº”èŒƒå›´çš„æäº¤è®°å½•
            let gitLogCmd;
            if (previousVersionCommit) {
              console.log(`è·å–ä» ${previousVersionCommit} åˆ° HEAD çš„æ‰€æœ‰æäº¤ï¼ˆå…± ${commitCount} ä¸ªï¼‰`);
              gitLogCmd = `git log ${previousVersionCommit}..HEAD --pretty=format:"%h|%s|%an|%ar"`;
            } else {
              console.log('æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æäº¤ï¼Œè·å–æœ€è¿‘ 20 æ¡æäº¤');
              gitLogCmd = 'git log -20 --pretty=format:"%h|%s|%an|%ar"';
            }

            const commits = execSync(gitLogCmd, { encoding: 'utf-8' })
              .split('\n')
              .filter(line => line.trim())
              .map(line => {
                const [hash, subject, author, date] = line.split('|');
                return { hash, subject, author, date };
              });

            console.log(`å®é™…è·å–åˆ° ${commits.length} ä¸ªæäº¤è®°å½•`);

            // å¦‚æœæ²¡æœ‰ API Keyï¼Œä½¿ç”¨é»˜è®¤æ€»ç»“
            if (!process.env.MODELSCOPE_API_KEY) {
              console.log('æœªé…ç½® MODELSCOPE_API_KEYï¼Œä½¿ç”¨é»˜è®¤æ€»ç»“');
              const summary = previousVersion
                ? `æœ¬æ¬¡ç‰ˆæœ¬ä» ${previousVersion} æ›´æ–°ï¼ŒåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`
                : `æœ¬æ¬¡æ„å»ºåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`;
              core.setOutput('summary', summary);
              return;
            }

            // è°ƒç”¨ ModelScope API ç”Ÿæˆæ€»ç»“ï¼ˆOpenAI å…¼å®¹æ ¼å¼ï¼‰
            try {
              const response = await fetch('https://api-inference.modelscope.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.MODELSCOPE_API_KEY}`
                },
                body: JSON.stringify({
                  model: 'Qwen/Qwen2.5-Coder-32B-Instruct',  // ä½¿ç”¨é€šä¹‰åƒé—® 2.5 Coder æ¨¡å‹
                  messages: [
                    {
                      role: 'system',
                      content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶ç‰ˆæœ¬å‘å¸ƒåŠ©æ‰‹ï¼Œæ“…é•¿åˆ†æ Git æäº¤è®°å½•å¹¶ç”Ÿæˆç»“æ„åŒ–çš„ç‰ˆæœ¬å‘å¸ƒæ–‡æ¡£ã€‚'
                    },
                    {
                      role: 'user',
                      content: `è¯·åˆ†æä»¥ä¸‹ Git æäº¤è®°å½•ï¼Œç”Ÿæˆç»“æ„åŒ–çš„ç‰ˆæœ¬å‘å¸ƒæ–‡æ¡£ã€‚

              æäº¤è®°å½•ï¼ˆå…± ${commits.length} ä¸ªï¼‰ï¼š
              ${commits.map(c => `- ${c.subject} (${c.author}, ${c.date})`).join('\n')}
            
              è¦æ±‚ï¼š
                1. ç”¨ä¸­æ–‡è¾“å‡º
                2. æŒ‰ç…§ä»¥ä¸‹æ ¼å¼åˆ†ç±»è¾“å‡ºï¼š

            ### âœ¨ æ–°å¢ï¼ˆAddedï¼‰
            - æ–°å¢çš„åŠŸèƒ½æˆ–ç‰¹æ€§
  
            ### ğŸ”§ å˜æ›´ï¼ˆChangedï¼‰
            - è¡Œä¸ºè°ƒæ•´ã€é‡æ„ã€é…ç½®å˜æ›´ç­‰
  
            ### ğŸ› ä¿®å¤ï¼ˆFixedï¼‰
            - Bug ä¿®å¤ã€é—®é¢˜è§£å†³ç­‰
  
            ### âš ï¸ åºŸå¼ƒï¼ˆDeprecatedï¼‰
            - å³å°†åºŸå¼ƒçš„åŠŸèƒ½ï¼ˆå¦‚æœæœ‰ï¼‰
  
            ### ğŸ“ å¤‡æ³¨ï¼ˆNotesï¼‰
            - é‡è¦çš„ä½¿ç”¨æ³¨æ„äº‹é¡¹æˆ–å…¼å®¹æ€§è¯´æ˜ï¼ˆå¦‚æœæœ‰ï¼‰
  
            3. **é‡è¦**ï¼šå¦‚æœæŸä¸ªåˆ†ç±»æ²¡æœ‰å†…å®¹ï¼Œå®Œå…¨çœç•¥è¯¥åˆ†ç±»çš„æ ‡é¢˜å’Œå†…å®¹ï¼Œä¸è¦è¾“å‡º"ï¼ˆæ— ï¼‰"
            4. æ¯ä¸ªè¦ç‚¹ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡ 30 å­—ï¼›æœ€å¥½ä¸è¦å¤ªå¤šå¤ªé•¿
            5. åˆå¹¶ç›¸ä¼¼çš„æäº¤,å…³äºä¸€ä¸‹ä»£ç å’Œæ‰“åŒ…ä»¥åŠä¸æ˜¯åŠŸèƒ½ä¸Šçš„æäº¤å°±ä¸è¦ä½“ç°æ€»ç»“å‡ºæ¥äº†
            6. çªå‡ºé‡è¦å˜æ›´, ä¸€äº›æ²¡å¿…è¦çš„å°±ä¸ä½“ç°å‡ºæ¥äº†ï¼Œåªä½“ç°å‡ºåŠŸèƒ½ä¸Šå’Œbugä¸Šçš„
            7. åªè¾“å‡ºæœ‰å†…å®¹çš„åˆ†ç±»å’Œè¦ç‚¹ï¼Œä¸è¦å…¶ä»–å†…å®¹ï¼Œä½ å°±æ·±åº¦æ€»ç»“ä¸€ä¸‹`
                            }
                  ],
                  temperature: 0.7,
                  max_tokens: 1024,
                  stream: false
                })
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
              }

              const data = await response.json();

              // OpenAI å…¼å®¹æ ¼å¼å“åº”
              if (data.choices && data.choices[0] && data.choices[0].message) {
                let summary = data.choices[0].message.content.trim();

                // æ¸…ç†å¯èƒ½çš„é‡å¤ "- " å‰ç¼€
                summary = summary.replace(/^- - /gm, '- ');

                console.log('AI ç”Ÿæˆçš„æ€»ç»“:');
                console.log(summary);
                console.log(`\nä½¿ç”¨çš„ tokens: è¾“å…¥=${data.usage.prompt_tokens}, è¾“å‡º=${data.usage.completion_tokens}, æ€»è®¡=${data.usage.total_tokens}`);

                core.setOutput('summary', summary);
              } else {
                throw new Error('API å“åº”æ ¼å¼å¼‚å¸¸');
              }
            } catch (error) {
              console.error('AI æ€»ç»“å¤±è´¥:', error.message);
              // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ€»ç»“
              const summary = previousVersion
                ? `æœ¬æ¬¡ç‰ˆæœ¬ä» ${previousVersion} æ›´æ–°ï¼ŒåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`
                : `æœ¬æ¬¡æ„å»ºåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`;
              core.setOutput('summary', summary);
            }

  build:
    name: æ‰“åŒ…ç¼–è¯‘
    needs: prepare
    if: needs.prepare.outputs.skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-amd64
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
          - target: linux-amd64-v3
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
            goamd64: "v3"
          - target: linux-amd64-musl
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
          - target: linux-amd64-musl-v3
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
            goamd64: "v3"
          - target: linux-arm64
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm64
          - target: linux-arm64-musl
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm64
          - target: linux-armv7
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm
            goarm: "7"
          - target: linux-armv6
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm
            goarm: "6"
          - target: linux-386
            runs_on: ubuntu-24.04
            goos: linux
            goarch: "386"
          - target: darwin-amd64
            runs_on: macos-15-intel
            goos: darwin
            goarch: amd64
          - target: darwin-arm64
            runs_on: macos-15
            goos: darwin
            goarch: arm64
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Checkout MSM ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: msm9527/msm
          ref: ${{ needs.prepare.outputs.branch }}
          token: ${{ secrets.MSM_REPO_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
          check-latest: true
          cache: true
          cache-dependency-path: backend/go.sum

      - name: ç¼“å­˜ Go æ„å»ºäº§ç‰©
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
          key: go-build-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('backend/go.sum') }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: ç¼“å­˜å‰ç«¯ä¾èµ–
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: npm-frontend-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}

      - name: æ„å»º supervisordï¼ˆåµŒå…¥èµ„æºï¼‰
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm || '' }}
          GOAMD64: ${{ matrix.goamd64 || '' }}
          CGO_ENABLED: ${{ matrix.goos == 'darwin' && '1' || '0' }}
        run: |
          set -euo pipefail
          SUPERVISORD_COMMIT="$(head -n 1 backend/cmd/msm/.supervisord.version | tr -d '\r\n')"
          if [ -z "${SUPERVISORD_COMMIT}" ]; then
            echo "error: backend/cmd/msm/.supervisord.version ä¸ºç©º" >&2
            exit 1
          fi
          echo "supervisord commit: ${SUPERVISORD_COMMIT}"

          rm -rf /tmp/supervisord
          git clone https://github.com/ochinchina/supervisord.git /tmp/supervisord
          git -C /tmp/supervisord checkout "${SUPERVISORD_COMMIT}"

          (cd /tmp/supervisord && go build -ldflags="-s -w" -o supervisord)
          cp /tmp/supervisord/supervisord backend/cmd/msm/supervisord

      - name: æ„å»ºå‰ç«¯å¹¶å¤åˆ¶åˆ°åç«¯ï¼ˆåµŒå…¥èµ„æºï¼‰
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm ci --no-audit --no-fund
          npm run build

          test -d dist

          rm -rf ../backend/cmd/msm/frontend/dist
          mkdir -p ../backend/cmd/msm/frontend
          cp -r dist ../backend/cmd/msm/frontend/

      - name: ç¼–è¯‘ MSMï¼ˆäºŒè¿›åˆ¶ä¼˜åŒ–ç‰ˆï¼‰
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm || '' }}
          GOAMD64: ${{ matrix.goamd64 || '' }}
          CGO_ENABLED: ${{ matrix.goos == 'darwin' && '1' || '0' }}
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p dist
          cd backend
          go build -ldflags="-s -w" -o ../dist/msm ./cmd/msm
          cd ..
          chmod +x dist/msm

          # ç»Ÿä¸€æ‰“åŒ… CLI äºŒè¿›åˆ¶ä¸º tar.gzï¼ˆmacOS / Linux ä¸€è‡´ï¼‰
          tar -czf "dist/msm-${VERSION}-${{ matrix.target }}.tar.gz" -C dist msm
          rm -f dist/msm

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© - äºŒè¿›åˆ¶ (macOS)
        if: matrix.goos == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz
          if-no-files-found: error

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Linux)
        if: matrix.goos != 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz
          if-no-files-found: error

  release:
    name: å‘å¸ƒæ„å»ºäº§ç‰©ï¼ˆ${{ needs.prepare.outputs.channel_name }}ï¼‰
    needs: [prepare, build]
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout å½“å‰ä»“åº“ï¼ˆmsm-wikiï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: åˆ›å»º/æ›´æ–°ç‰ˆæœ¬ tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          SHA="${GITHUB_SHA}"
          CHANNEL_NAME="${{ needs.prepare.outputs.channel_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ é™¤æ—§çš„ç‰ˆæœ¬ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git tag -d "${VERSION}" >/dev/null 2>&1 || true
          git push origin ":refs/tags/${VERSION}" || true

          # åˆ›å»ºæ–°çš„ç‰ˆæœ¬ tag
          git tag -a "${VERSION}" -m "${CHANNEL_NAME} æ¯æ—¥æ„å»º ${VERSION}" "${SHA}"
          git push origin "refs/tags/${VERSION}"

      - name: åˆ›å»º/æ›´æ–° GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.prepare.outputs.version }}
          name: ğŸš€ MSM ${{ needs.prepare.outputs.version }}ï¼ˆ${{ needs.prepare.outputs.channel_name }}ï¼‰
          body: |
            <div align="center">

            # ğŸ“¦ MSM ${{ needs.prepare.outputs.version }}

            ![Build Status](https://img.shields.io/badge/build-passing-brightgreen)
            ![Version](https://img.shields.io/badge/version-${{ needs.prepare.outputs.version }}-blue)
            ![Platform](https://img.shields.io/badge/platform-linux%20%7C%20macos-lightgrey)

            **${{ needs.prepare.outputs.channel_name }}æ¯æ—¥è‡ªåŠ¨æ„å»º Â· åŒ…å«æœ€æ–°ä»£ç æ›´æ–°**

            </div>

            ---

            ## âœ¨ æœ¬æ¬¡æ›´æ–°

            ${{ needs.prepare.outputs.ai_summary }}

            ---

            ## ğŸ“‹ æ„å»ºä¿¡æ¯

            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **ç‰ˆæœ¬å·** | `${{ needs.prepare.outputs.version }}` |
            | **å‘å¸ƒé€šé“** | `${{ needs.prepare.outputs.channel }}` |
            | **æºä»“åº“** | [msm9527/msm](https://github.com/msm9527/msm) |
            | **æ„å»ºåˆ†æ”¯** | `${{ needs.prepare.outputs.branch }}` ğŸŒ¿ |
            | **æºæäº¤** | [`${{ needs.prepare.outputs.commit_sha_short }}`](https://github.com/msm9527/msm/commit/${{ needs.prepare.outputs.commit_sha }}) |
            | **æ„å»ºæ—¶é—´** | ${{ github.event.repository.updated_at }} â° |

            <details>
            <summary>ğŸ¯ æœ€æ–°æäº¤è¯¦æƒ…</summary>

            **${{ needs.prepare.outputs.commit_message }}**

            - ğŸ“… æ—¶é—´: ${{ needs.prepare.outputs.commit_date }}
            - ğŸ”— é“¾æ¥: https://github.com/msm9527/msm/commit/${{ needs.prepare.outputs.commit_sha }}

            </details>

            ---

            ## ğŸ’¾ ä¸‹è½½å®‰è£…

            ### ğŸ–¥ï¸ å‘½ä»¤è¡Œç‰ˆæœ¬ï¼ˆCLIï¼‰

            <details open>
            <summary><b>Linux å¹³å°</b></summary>

            | æ¶æ„ | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **amd64** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz) | æ ‡å‡†ç‰ˆæœ¬ï¼ˆæ¨èï¼‰ |
            | **amd64-v3** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64-v3.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64-v3.tar.gz) | ä¼˜åŒ–ç‰ˆï¼ˆéœ€ AVX2ï¼‰ |
            | **amd64-musl** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl.tar.gz) | Alpine Linux |
            | **amd64-musl-v3** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl-v3.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl-v3.tar.gz) | Alpine ä¼˜åŒ–ç‰ˆ |
            | **arm64** | [`msm-${{ needs.prepare.outputs.version }}-linux-arm64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-arm64.tar.gz) | ARM 64ä½ |
            | **arm64-musl** | [`msm-${{ needs.prepare.outputs.version }}-linux-arm64-musl.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-arm64-musl.tar.gz) | ARM Alpine |
            | **armv7** | [`msm-${{ needs.prepare.outputs.version }}-linux-armv7.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-armv7.tar.gz) | ARM v7 |
            | **armv6** | [`msm-${{ needs.prepare.outputs.version }}-linux-armv6.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-armv6.tar.gz) | ARM v6 |
            | **386** | [`msm-${{ needs.prepare.outputs.version }}-linux-386.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-386.tar.gz) | 32ä½ x86 |

            > **ğŸ’¡ æç¤ºï¼š** amd64-v3 ç‰ˆæœ¬é’ˆå¯¹è¾ƒæ–°çš„ CPU è¿›è¡Œäº†ä¼˜åŒ–ï¼ˆéœ€è¦æ”¯æŒ AVXã€AVX2 ç­‰æŒ‡ä»¤é›†ï¼‰ï¼Œæ€§èƒ½æ›´å¥½ä½†å…¼å®¹æ€§è¾ƒä½ã€‚å¦‚æœä¸ç¡®å®šï¼Œè¯·ä½¿ç”¨æ ‡å‡†çš„ amd64 ç‰ˆæœ¬ã€‚

            </details>

            <details>
            <summary><b>macOS å¹³å°</b></summary>

            | æ¶æ„ | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **Intel** | [`msm-${{ needs.prepare.outputs.version }}-darwin-amd64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-darwin-amd64.tar.gz) | Intel èŠ¯ç‰‡ Mac |
            | **Apple Silicon** | [`msm-${{ needs.prepare.outputs.version }}-darwin-arm64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-darwin-arm64.tar.gz) | M1/M2/M3 èŠ¯ç‰‡ |

            </details>

            ### ğŸ–¼ï¸ æ¡Œé¢åº”ç”¨ç‰ˆæœ¬ï¼ˆDesktopï¼‰

            <details>
            <summary><b>macOS æ¡Œé¢åº”ç”¨</b></summary>

            | æ¶æ„ | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **Intel** | [`msm-desktop-${{ needs.prepare.outputs.version }}-darwin-amd64.dmg`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-desktop-${{ needs.prepare.outputs.version }}-darwin-amd64.dmg) | Intel èŠ¯ç‰‡ Mac |
            | **Apple Silicon** | [`msm-desktop-${{ needs.prepare.outputs.version }}-darwin-arm64.dmg`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-desktop-${{ needs.prepare.outputs.version }}-darwin-arm64.dmg) | M1/M2/M3 èŠ¯ç‰‡ |

            **å®‰è£…æ­¥éª¤ï¼š**
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æ–‡ä»¶
            2. åŒå‡» DMG æ–‡ä»¶ï¼Œå°†åº”ç”¨æ‹–å…¥ Applications æ–‡ä»¶å¤¹
            3. é¦–æ¬¡æ‰“å¼€æ—¶ï¼Œå¦‚æœé‡åˆ°"æ— æ³•éªŒè¯å¼€å‘è€…"æç¤ºï¼š
               - æ‰“å¼€"ç³»ç»Ÿè®¾ç½®" â†’ "éšç§ä¸å®‰å…¨æ€§"
               - ç‚¹å‡»"ä»è¦æ‰“å¼€"æŒ‰é’®
            4. ç”±äºåº”ç”¨æœªç»è¿‡ Apple å…¬è¯ï¼Œæç¤ºæ–‡ä»¶æŸåæ‰§è¡Œä¸‹è¾¹å‘½ä»¤
               - /usr/bin/xattr -cr "/Applications/msm-desktop.app" && /usr/bin/codesign -fs - "/Applications/msm-desktop.app"

            </details>

            ---

            ## ğŸš€ å¿«é€Ÿå®‰è£…

            ### ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰

            ```bash
            curl -fsSL ${{ needs.prepare.outputs.install_script_url }} | sudo bash
            ```

            ### æ‰‹åŠ¨å®‰è£…ï¼ˆä»¥ Linux amd64 ä¸ºä¾‹ï¼‰

            ```bash
            # ä¸‹è½½
            wget https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz

            # è§£å‹
            tar -xzf msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz

            # å®‰è£…
            sudo mv msm /usr/local/bin/msm
            sudo chmod +x /usr/local/bin/msm

            # éªŒè¯
            msm --version
            ```

            ### Docker å®‰è£…

            ```bash
            # æ‹‰å–é•œåƒ
            docker pull msmbox/msm:${{ needs.prepare.outputs.version }}

            # è¿è¡Œå®¹å™¨
            docker run -d \
              --name msm \
              -p 7777:7777 \
              -v /opt/msm:/opt/msm \
              msmbox/msm:${{ needs.prepare.outputs.version }}
            ```

            ---

            ## ğŸ“š æ–‡æ¡£ä¸æ”¯æŒ

            - ğŸ“– [å®Œæ•´æ–‡æ¡£](https://msm9527.github.io/msm-wiki/)
            - ğŸš€ [å¿«é€Ÿå¼€å§‹](https://msm9527.github.io/msm-wiki/zh/guide/install.html)
            - ğŸ“ [ç‰ˆæœ¬å‘å¸ƒ](${{ needs.prepare.outputs.release_docs_url }})
            - ğŸ’¬ [é—®é¢˜åé¦ˆ](https://github.com/msm9527/msm/issues)

            ---

            <div align="center">

            **ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ„å»º**

            [![GitHub](https://img.shields.io/badge/GitHub-msm9527%2Fmsm-blue?logo=github)](https://github.com/msm9527/msm)
            [![Documentation](https://img.shields.io/badge/docs-msm--wiki-green)](https://msm9527.github.io/msm-wiki/)
            [![Docker](https://img.shields.io/badge/docker-msmbox%2Fmsm-blue?logo=docker)](https://hub.docker.com/r/msmbox/msm)

            </div>
          makeLatest: ${{ needs.prepare.outputs.is_stable }}
          prerelease: ${{ needs.prepare.outputs.is_beta }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: |
            dist/**/msm-${{ needs.prepare.outputs.version }}-*.tar.gz

      - name: æ›´æ–° Wiki ç‰ˆæœ¬å‘å¸ƒé¡µé¢
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');

            const version = '${{ needs.prepare.outputs.version }}';
            const baseVersion = '${{ needs.prepare.outputs.base_version }}';
            const channel = '${{ needs.prepare.outputs.channel }}';
            const channelName = '${{ needs.prepare.outputs.channel_name }}';
            const aiSummary = ${{ toJSON(needs.prepare.outputs.ai_summary) }};
            const commitSha = '${{ needs.prepare.outputs.commit_sha_short }}';
            const commitShaFull = '${{ needs.prepare.outputs.commit_sha }}';
            const commitMessage = ${{ toJSON(needs.prepare.outputs.commit_message) }};
            const commitAuthor = ${{ toJSON(needs.prepare.outputs.commit_author) }};
            const commitDate = '${{ needs.prepare.outputs.commit_date }}';
            const latestVersionMarker = '${{ needs.prepare.outputs.latest_marker }}';
            const historyVersionMarker = '${{ needs.prepare.outputs.history_marker }}';
            const releasesPath = '${{ needs.prepare.outputs.release_notes_path }}';

            // è¯»å–ç°æœ‰çš„ç‰ˆæœ¬å‘å¸ƒé¡µé¢
            let content = fs.readFileSync(releasesPath, 'utf-8');

            // ä½¿ç”¨æœ€åä¸€ä¸ª commit çš„æ—¶é—´ä½œä¸ºå‘å¸ƒæ—¥æœŸï¼ˆç²¾ç¡®åˆ°åˆ†é’Ÿï¼‰
            // commitDate æ ¼å¼: "2026-01-09 12:34:56 +0800"
            const commitDateObj = new Date(commitDate);
            const dateStr = commitDateObj.toLocaleString('zh-CN', {
              // ç»Ÿä¸€æŒ‰åŒ—äº¬æ—¶é—´å±•ç¤ºï¼Œé¿å… runner æ—¶åŒºï¼ˆUTCï¼‰å¯¼è‡´æ˜¾ç¤ºåç§» 8 å°æ—¶
              timeZone: 'Asia/Shanghai',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            }).replace(/\//g, '-');

            // æ„å»ºæ–°ç‰ˆæœ¬çš„å†…å®¹ï¼ˆä¸æ–°ç‰ˆ releases é¡µé¢ç»“æ„å¯¹é½ï¼‰
            const versionLabel = channel === 'beta'
              ? `å½“å‰ Beta ç‰ˆæœ¬ï¼š\`${version}\``
              : `å½“å‰ç¨³å®šç‰ˆæœ¬ï¼š\`v${baseVersion}\``;
            const newVersionContent = `
            > ${versionLabel}  
            > å‘å¸ƒæ—¶é—´ï¼š${dateStr}  
            > - å‘å¸ƒé¡µï¼š<https://github.com/msm9527/msm-wiki/releases/tag/${version}>  
            > - ä¸‹è½½æ–¹å¼ï¼šåŒä¸€å‘å¸ƒé¡µå†…æä¾›å„å¹³å°äºŒè¿›åˆ¶ä¸å®‰è£…åŒ…
            
            ${aiSummary}
            
            ::: details ğŸ“‹ æ„å»ºä¿¡æ¯
            - **å‘å¸ƒé€šé“**: ${channel}ï¼ˆ${channelName}ï¼‰
            - **æºæäº¤**: [\`${commitSha}\`](https://github.com/msm9527/msm/commit/${commitShaFull})
            - **æäº¤ä¿¡æ¯**: ${commitMessage}
            - **æäº¤ä½œè€…**: ${commitAuthor}
            - **æäº¤æ—¶é—´**: ${commitDate}
            :::
            
            ---
            `;

            if (content.includes(latestVersionMarker) && content.includes(historyVersionMarker)) {
              // æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬å’Œå†å²ç‰ˆæœ¬çš„ä½ç½®
              const latestIndex = content.indexOf(latestVersionMarker);
              const historyIndex = content.indexOf(historyVersionMarker);

              if (latestIndex !== -1 && historyIndex !== -1) {
                // ä¿ç•™æ ‡é¢˜ä¹‹å‰çš„å†…å®¹
                const beforeLatest = content.substring(0, latestIndex + latestVersionMarker.length);
                // ä¿ç•™å†å²ç‰ˆæœ¬åŠä¹‹åçš„å†…å®¹
                const afterHistory = content.substring(historyIndex);

                // é‡æ–°ç»„è£…ï¼šæ ‡é¢˜å‰ + æ ‡é¢˜ + æ–°ç‰ˆæœ¬å†…å®¹ + å†å²ç‰ˆæœ¬åŠä¹‹å
                content = beforeLatest + '\n\n' + newVersionContent + '\n' + afterHistory;
              }
            } else {
              console.log('âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬æ ‡è®°ï¼Œè·³è¿‡æ›´æ–°');
            }

            // å†™å›æ–‡ä»¶
            fs.writeFileSync(releasesPath, content, 'utf-8');

            console.log(`âœ… å·²æ›´æ–°ç‰ˆæœ¬å‘å¸ƒé¡µé¢: ${version}`);

      - name: æäº¤ Wiki æ›´æ–°
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${{ needs.prepare.outputs.release_notes_path }}"

          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°${{ needs.prepare.outputs.channel_name }}å‘å¸ƒé¡µé¢: ${{ needs.prepare.outputs.version }}

            - æ·»åŠ ç‰ˆæœ¬ ${{ needs.prepare.outputs.version }} çš„å‘å¸ƒä¿¡æ¯
            - AI ç”Ÿæˆçš„æ›´æ–°æ€»ç»“
            - æ„å»ºä¿¡æ¯å’Œä¸‹è½½é“¾æ¥

            Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

            git push
            echo "âœ… å·²æ¨é€ Wiki æ›´æ–°"
          fi

  docker:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    needs: [prepare, release]
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: å‡†å¤‡å„æ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"

          # åˆ›å»ºç›®å½•ç»“æ„ binaries/{platform}/msm
          mkdir -p binaries/linux/amd64 binaries/linux/arm64 binaries/linux/arm/v7 binaries/linux/arm/v6 binaries/linux/386

          # è§£å‹å¹¶å¤åˆ¶å„æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo "å‡†å¤‡ linux/amd64 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-amd64/msm-${VERSION}-linux-amd64.tar.gz" -C binaries/linux/amd64

          echo "å‡†å¤‡ linux/arm64 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-arm64/msm-${VERSION}-linux-arm64.tar.gz" -C binaries/linux/arm64

          echo "å‡†å¤‡ linux/arm/v7 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-armv7/msm-${VERSION}-linux-armv7.tar.gz" -C binaries/linux/arm/v7

          echo "å‡†å¤‡ linux/arm/v6 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-armv6/msm-${VERSION}-linux-armv6.tar.gz" -C binaries/linux/arm/v6

          echo "å‡†å¤‡ linux/386 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-386/msm-${VERSION}-linux-386.tar.gz" -C binaries/linux/386

          # éªŒè¯æ–‡ä»¶ç»“æ„
          echo "éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶:"
          find binaries -name msm -exec ls -lh {} \;

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€å¤šæ¶æ„ Docker é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.binary
          platforms: linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6,linux/386
          push: true
          tags: msmbox/msm:${{ needs.prepare.outputs.version }},msmbox/msm:${{ needs.prepare.outputs.docker_channel_tag }}
          labels: |
            org.opencontainers.image.title=MSM
            org.opencontainers.image.description=Mosdns Singbox Mihomo Manager
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.source=https://github.com/msm9527/msm
            org.opencontainers.image.url=https://msm9527.github.io/msm-wiki/
          provenance: false
          sbom: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=image,push=true

      - name: æ˜¾ç¤ºé•œåƒä¿¡æ¯
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          CHANNEL_TAG="${{ needs.prepare.outputs.docker_channel_tag }}"
          echo "âœ… Docker é•œåƒå·²æ¨é€åˆ° Docker Hub"
          echo ""
          echo "é•œåƒæ ‡ç­¾:"
          echo "  - msmbox/msm:${VERSION}"
          echo "  - msmbox/msm:${CHANNEL_TAG}"
          echo ""
          echo "æ”¯æŒçš„æ¶æ„:"
          echo "  - linux/amd64"
          echo "  - linux/arm64"
          echo "  - linux/arm/v7"
          echo "  - linux/arm/v6"
          echo "  - linux/386"
          echo ""
          echo "æ³¨æ„: Docker é•œåƒä½¿ç”¨æ ‡å‡† amd64 ç‰ˆæœ¬ï¼Œamd64-v3 ä¼˜åŒ–ç‰ˆä»…ä½œä¸ºç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶æä¾›"
          echo ""

  upload:
    name: ä¸Šä¼ æ¯æ—¥æ„å»ºåˆ°è‡ªå®šä¹‰æœåŠ¡å™¨
    needs: [prepare, release]
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ubuntu-24.04
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: å‡†å¤‡ä¸Šä¼ æ–‡ä»¶
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p upload/"${VERSION}"
          find dist -type f -name "msm-${VERSION}-*.tar.gz" -exec cp {} upload/"${VERSION}"/ \;
          printf "%s\n" "${VERSION}" > upload/.version
          echo "å¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨:"
          ls -lh upload
          ls -lh upload/"${VERSION}"

      - name: å®‰è£… sshpass
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass rsync

      - name: ä¼ è¾“åˆ°ç›®æ ‡æœåŠ¡å™¨
        shell: bash
        env:
          EXTRA_SERVERS: ${{ secrets.DEPLOY_SERVERS }}
        run: |
          set -euo pipefail

          VERSION="${{ needs.prepare.outputs.version }}"
          CHANNEL="${{ needs.prepare.outputs.channel }}"
          RSYNC_SSH="ssh -o StrictHostKeyChecking=no"

          # ä»…ä½¿ç”¨ DEPLOY_SERVERS å¤šè¡Œé…ç½®ï¼šhost,user,password,target_path[,port]
          servers=()
          if [ -n "${EXTRA_SERVERS}" ]; then
            while IFS= read -r line; do
              line_trimmed="$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
              [ -z "$line_trimmed" ] && continue
              servers+=("$line_trimmed")
            done <<< "${EXTRA_SERVERS}"
          fi

          if [ ${#servers[@]} -eq 0 ]; then
            echo "æœªæä¾›æœåŠ¡å™¨ä¿¡æ¯ï¼ˆè¯·åœ¨ secrets ä¸­è®¾ç½® DEPLOY_SERVERSï¼Œå¤šè¡Œ host,user,password,target_path[,port]ï¼‰"
            exit 0
          fi

          echo "å³å°†ä¸Šä¼ åˆ° ${#servers[@]} ä¸ªæœåŠ¡å™¨:"
          for entry in "${servers[@]}"; do
            IFS=',' read -r host user pass target port <<< "$entry"
            safe_host="$(echo "$host" | sed -E 's/^(.{0,3}).*(.)$/\1*******\2/')"
            echo " - ${safe_host}"
          done

          for entry in "${servers[@]}"; do
            IFS=',' read -r host user pass target port <<< "$entry"
            if [ -z "${host}" ] || [ -z "${user}" ] || [ -z "${pass}" ] || [ -z "${target}" ]; then
              echo "è·³è¿‡æ— æ•ˆé…ç½®"
              continue
            fi

            TARGET="${target%/}"
            if [ "${CHANNEL}" = "beta" ]; then
              TARGET="${TARGET}/beta"
            fi
            PORT_OPT=""
            if [ -n "${port}" ]; then
              PORT_OPT="-p ${port}"
            fi

            sshpass -p "${pass}" ssh -o StrictHostKeyChecking=no ${PORT_OPT} "${user}@${host}" "mkdir -p \"${TARGET}\" \"${TARGET}/${VERSION}\""

            sshpass -p "${pass}" rsync -avz --no-perms --no-owner --no-group -e "${RSYNC_SSH} ${PORT_OPT}" --rsync-path="mkdir -p \"${TARGET}\" && rsync" upload/.version "${user}@${host}:${TARGET}/"
            sshpass -p "${pass}" rsync -avz --no-perms --no-owner --no-group -e "${RSYNC_SSH} ${PORT_OPT}" --rsync-path="mkdir -p \"${TARGET}/${VERSION}\" && rsync" upload/${VERSION}/ "${user}@${host}:${TARGET}/${VERSION}/"
          done

          echo "âœ… å·²å°† .version å’Œæ‰“åŒ…äº§ç‰©ä¸Šä¼ è‡³æ‰€æœ‰æœåŠ¡å™¨"
          echo "ä½¿ç”¨æ–¹å¼:"
          echo "  docker pull msmbox/msm:${{ needs.prepare.outputs.docker_channel_tag }}"
          echo "  docker run -d -p 7777:7777 msmbox/msm:${{ needs.prepare.outputs.docker_channel_tag }}"

  desktop:
    name: æ„å»º macOS æ¡Œé¢åº”ç”¨å¹¶è¿½åŠ åˆ° Release
    needs: [prepare, release]
    runs-on: macos-15
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-amd64
            goos: darwin
            goarch: amd64
          - target: darwin-arm64
            goos: darwin
            goarch: arm64
    steps:
      - name: Checkout MSM ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: msm9527/msm
          ref: ${{ needs.prepare.outputs.branch }}
          token: ${{ secrets.MSM_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: ç¼“å­˜å‰ç«¯ä¾èµ–
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: npm-frontend-desktop-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ç¼“å­˜ Cargo ä¾èµ–ä¸æ„å»º
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            frontend/src-tauri/target
          key: cargo-tauri-${{ runner.os }}-${{ hashFiles('frontend/src-tauri/Cargo.lock') }}

      - name: å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»ºï¼ˆTauri æ¡Œé¢ï¼‰
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm ci --no-audit --no-fund
          npm run build

      - name: ä¸‹è½½ macOS CLI æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist

      - name: è§£å‹ CLI äºŒè¿›åˆ¶ä¾› Tauri ä½¿ç”¨
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p dist
          # è§£å‹å‡º msm å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä½¿ç”¨ build Job ä¸Šä¼ çš„ tar.gz äº§ç‰©ï¼‰
          tar -xzf "dist/msm-${VERSION}-${{ matrix.target }}.tar.gz" -C dist
          ls -l dist

      - name: æ„å»º Tauri æ¡Œé¢åº”ç”¨
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"

          export TAURI_APP_VERSION="${VERSION}"
          export TAURI_BUILD_VERSION="${VERSION}"

          cd frontend

          WORKSPACE="$PWD"
          SRC_TAURI_DIR="$WORKSPACE/src-tauri"
          DIST_ROOT="$WORKSPACE/../dist"

          # ç¡®ä¿ç›®å½•å­˜åœ¨ï¼›å¦‚å­˜åœ¨å¼€å‘ç”¨çš„ msm å¯æ‰§è¡Œæ–‡ä»¶æˆ–ç›®å½•ï¼Œå…ˆç§»é™¤
          mkdir -p "$SRC_TAURI_DIR"
          if [ -e "$SRC_TAURI_DIR/msm" ] || [ -L "$SRC_TAURI_DIR/msm" ]; then
            rm -rf "$SRC_TAURI_DIR/msm"
          fi

          # å¤åˆ¶å·²è§£å‹å¥½çš„äºŒè¿›åˆ¶åˆ° src-tauri/msm
          cp "$DIST_ROOT/msm" "$SRC_TAURI_DIR/msm"
          chmod +x "$SRC_TAURI_DIR/msm"

          # å¤åˆ¶å¿…è¦çš„èµ„æºæ–‡ä»¶ï¼ˆå­˜åœ¨æ‰å¤åˆ¶ï¼‰
          cp about.html dist/ || true
          cp icon.png dist/ || true

          # è·³è¿‡é‡å¤çš„å‰ç«¯æ„å»º
          TAURI_CONF="$SRC_TAURI_DIR/tauri.conf.json"
          cp "$TAURI_CONF" "$TAURI_CONF.backup"
          sed -i.tmp 's/"beforeBuildCommand":[^,]*,/"beforeBuildCommand": "echo Skipping frontend build",/' "$TAURI_CONF"

          # ä½¿ç”¨ Tauri æ„å»º DMG
          npm run tauri build

          # æ¢å¤åŸå§‹é…ç½®
          mv "$TAURI_CONF.backup" "$TAURI_CONF"

          # å¤åˆ¶ DMG åˆ° dist ç›®å½•ï¼Œæ–‡ä»¶åå¸¦ä¸Šæ¶æ„
          mkdir -p "$DIST_ROOT"
          cp "$SRC_TAURI_DIR/target/release/bundle/dmg"/*.dmg "$DIST_ROOT/msm-desktop-${VERSION}-${{ matrix.target }}.dmg"

      - name: ä¸Šä¼ æ¡Œé¢åº”ç”¨ DMG äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: msm-desktop-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-desktop-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.dmg
          if-no-files-found: ignore

      - name: å°† DMG é™„åŠ åˆ°å·²æœ‰ Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          files: dist/msm-desktop-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.dmg
          fail_on_unmatched_files: false

  pages:
    name: æ„å»ºå¹¶å‘å¸ƒ Wiki åˆ° GitHub Pages
    needs: [prepare, release]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    concurrency:
      group: pages
      cancel-in-progress: false
    steps:
      - name: Checkout Wiki ä»“åº“
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ç¼“å­˜æ–‡æ¡£ä¾èµ–
        uses: actions/cache@v4
        with:
          path: node_modules
          key: npm-docs-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Install dependencies
        run: npm ci

      - name: Build with VitePress
        run: npm run docs:build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
